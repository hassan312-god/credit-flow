name: 'Build and Release'

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (ubuntu only)
      if: matrix.platform == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

    - name: Rust setup
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

    - name: Rust cache
      uses: swatinemu/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Sync node version and setup cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install frontend dependencies
      run: npm ci

    - name: Build the app
      uses: tauri-apps/tauri-action@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      with:
        tagName: app-v__VERSION__
        releaseName: 'NFA KA S√âRUM v__VERSION__'
        releaseBody: |
          ## Nouvelle version de N'FA KA S√âRUM v__VERSION__
          
          ### üöÄ Nouvelles fonctionnalit√©s
          - Synchronisation automatique toutes les 15 minutes
          - T√©l√©chargement automatique toutes les heures
          - Suppression des boutons manuels de synchronisation
          - Configuration du syst√®me de mise √† jour automatique
          
          ### üêõ Corrections
          - Am√©lioration de la gestion des erreurs de cr√©ation d'utilisateur
          - Messages d'erreur sp√©cifiques et en fran√ßais
          - Correction des erreurs de connexion dans les logs
          
          ### üì¶ Fichiers
          - Windows: `.msi` (recommand√©) et `.exe` (portable)
          - macOS: `.dmg` et `.app`
          - Linux: `.AppImage` et `.deb`
          
          ### üîß Installation
          1. T√©l√©chargez le fichier correspondant √† votre syst√®me
          2. Lancez l'installateur
          3. Suivez les instructions d'installation
          
          ---
          **Note**: Cette version inclut le syst√®me de mise √† jour automatique.
        releaseDraft: false
        prerelease: false
        args: ${{ matrix.args }}
        uploadUpdaterJson: true
        uploadUpdaterSignatures: true
